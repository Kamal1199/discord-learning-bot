const { Client, GatewayIntentBits, SlashCommandBuilder, REST, Routes, PermissionFlagsBits } = require('discord.js');
const express = require('express');

// گرفتن توکن و Client ID از Secrets
const TOKEN = process.env.TOKEN;
const CLIENT_ID = process.env.CLIENT_ID;
const GUILD_ID = process.env.GUILD_ID; // اختیاری برای تست روی یک سرور خاص

// وب‌سرور ساده برای نگه داشتن ربات آنلاین
const app = express();
app.get("/", (req, res) => res.send("🤖 Discord Bot is running..."));
app.listen(3000, () => console.log("🌐 Web server running on port 3000"));

// ایجاد کلاینت Discord
const client = new Client({ intents: [GatewayIntentBits.Guilds] });

// تعریف دستورات /kml و /viros
const commands = [
  new SlashCommandBuilder()
    .setName('kml')
    .setDescription('۳۱۳ تا چنل عددی بساز (هر ۲ ثانیه یکی)'),
  new SlashCommandBuilder()
    .setName('viros')
    .setDescription('⚠️ همه‌ی چنل‌های سرور رو پاک کن (فقط ادمین)')
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator)
].map(cmd => cmd.toJSON());

// ثبت دستورات
const rest = new REST({ version: '10' }).setToken(TOKEN);

(async () => {
  try {
    if (GUILD_ID) {
      console.log('🔄 ثبت دستورات روی Guild (تست) ...');
      await rest.put(Routes.applicationGuildCommands(CLIENT_ID, GUILD_ID), { body: commands });
    } else {
      console.log('🔄 ثبت دستورات Global ...');
      await rest.put(Routes.applicationCommands(CLIENT_ID), { body: commands });
    }
    console.log('✅ دستورات ثبت شدند!');
  } catch (err) {
    console.error(err);
  }
})();

// آماده شدن ربات
client.once('ready', () => console.log(`🤖 وارد شدم به عنوان ${client.user.tag}`));

// اجرای دستورات
client.on('interactionCreate', async interaction => {
  if (!interaction.isChatInputCommand()) return;

  if (interaction.commandName === 'kml') {
    await interaction.reply('🚀 شروع شد! در حال ساخت 313 چنل (هر ۲ ثانیه یکی)...');
    let i = 1;
    const interval = setInterval(async () => {
      if (i > 313) {
        clearInterval(interval);
        interaction.followUp('✅ همه‌ی 313 چنل ساخته شدند!');
        return;
      }
      try { await interaction.guild.channels.create({ name: `${i}`, type: 0 }); } 
      catch (err) { console.error(`❌ خطا در ساخت چنل ${i}:`, err); }
      i++;
    }, 2000);
  }

  if (interaction.commandName === 'viros') {
    await interaction.reply('⚠️ عملیات حذف همه‌ی چنل‌ها شروع شد...');
    try {
      const channels = interaction.guild.channels.cache;
      for (const [id, channel] of channels) {
        try { await channel.delete(); console.log(`🗑️ حذف شد: ${channel.name}`); } 
        catch (err) { console.error(`❌ خطا در حذف ${channel.name}:`, err); }
      }
      await interaction.followUp('✅ همه‌ی کانال‌ها پاک شدند!');
    } catch (err) {
      console.error('❌ خطا در حذف کانال‌ها:', err);
      await interaction.followUp('❌ خطا در حذف کانال‌ها!');
    }
  }
});

// لاگین با توکن از Secrets
client.login(TOKEN);
